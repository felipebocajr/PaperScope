<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Paper Rank ‚Äî AI Research Digest</title>
  
  <!-- Markdown & LaTeX Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

  <style>
    :root {
      --bg-color: #0b0f19;
      --card-bg: #111827;
      --card-border: #1f2937;
      --text-primary: #f3f4f6;
      --text-secondary: #9ca3af;
      --accent-color: #3b82f6;
      --accent-hover: #60a5fa;
      --accent-bg: rgba(59, 130, 246, 0.1);
      
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      color-scheme: dark;
    }

    body {
      margin: 0;
      background: var(--bg-color);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    a { color: var(--accent-color); text-decoration: none; transition: color 0.2s ease;}
    a:hover { color: var(--accent-hover); }

    .top-bar {
      text-align: right;
      padding: 12px 20px 0;
      max-width: 900px;
      margin: 0 auto;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .top-bar a {
      color: var(--text-secondary);
      text-decoration: underline;
      text-decoration-color: rgba(156, 163, 175, 0.3);
      text-underline-offset: 4px;
      transition: all 0.2s ease;
    }

    .top-bar a:hover {
      color: var(--text-primary);
      text-decoration-color: var(--text-primary);
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 20px 32px;
    }

    .header {
      margin-bottom: 8px; 
      text-align: center;
    }

    h1 { 
      margin: 0 0 8px 0; 
      font-size: 36px; 
      letter-spacing: -1px;
      font-weight: 800;
      background: linear-gradient(to right, #fff, #9ca3af);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .muted { color: var(--text-secondary); }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 32px;
      margin: 8px 0; 
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transition: opacity 0.3s ease;
    }

    .controls {
      display: flex;
      gap: 20px;
      padding: 20px 32px;
    }

    @media (max-width: 600px) {
      .controls { flex-direction: column; gap: 16px; }
    }

    .control {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    select, input[type="email"], textarea {
      appearance: none;
      background-color: #1f2937;
      border: 1px solid #374151;
      color: #f3f4f6;
      padding: 14px 16px;
      border-radius: 12px;
      outline: none;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    select {
      cursor: pointer;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%239ca3af%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpolyline%20points%3D%226%209%2012%2015%2018%209%22%3E%3C%2Fpolyline%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 40px;
    }

    input[type="email"]:focus, textarea:focus, select:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .loader-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 0;
      color: var(--text-secondary);
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid #1f2937;
      border-top-color: var(--accent-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .welcome-container {
      text-align: center;
      padding: 60px 20px;
    }

    .welcome-icon {
      font-size: 48px;
      margin-bottom: 24px;
      animation: float 3s ease-in-out infinite;
      display: inline-block;
    }

    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }

    .welcome-title {
      font-size: 28px;
      margin: 0 0 12px 0;
      color: var(--text-primary);
      font-weight: 700;
    }

    .welcome-text {
      font-size: 16px;
      color: var(--text-secondary);
      max-width: 480px;
      margin: 0 auto;
      line-height: 1.6;
    }

    .paper-title {
      margin: 0 0 20px;
      font-size: 24px;
      line-height: 1.4;
      font-weight: 700;
    }

    .paper-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 24px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 8px;
      background: #1f2937;
      border: 1px solid #374151;
      font-size: 13px;
      font-weight: 500;
      color: #d1d5db;
    }

    /* ------------------------- */
    /* Markdown Summary Styles   */
    /* ------------------------- */
    .summary {
      font-size: 16px;
      color: #d1d5db;
      line-height: 1.6;
    }

    .summary p { margin: 0 0 16px 0; }
    .summary p:last-child { margin-bottom: 0; }
    .summary strong { color: #fff; font-weight: 700; }
    .summary em { font-style: italic; color: #e5e7eb; }
    
    .summary h1, .summary h2, .summary h3, .summary h4, .summary h5, .summary h6 {
      color: #fff;
      margin: 24px 0 12px 0;
      font-weight: 600;
      line-height: 1.3;
    }
    .summary h1 { font-size: 24px; }
    .summary h2 { font-size: 20px; border-bottom: 1px solid #374151; padding-bottom: 6px; }
    .summary h3 { font-size: 18px; }
    .summary h4 { font-size: 16px; }

    .summary ul, .summary ol {
      margin: 0 0 16px 0;
      padding-left: 24px;
    }
    .summary li { margin-bottom: 8px; }
    .summary li::marker { color: var(--accent-color); }

    .summary blockquote {
      border-left: 4px solid var(--accent-color);
      margin: 0 0 16px 0;
      padding: 12px 16px;
      background: var(--accent-bg);
      border-radius: 0 8px 8px 0;
      color: #9ca3af;
      font-style: italic;
    }
    .summary blockquote p:last-child { margin-bottom: 0; }

    .summary code {
      background: #1f2937;
      padding: 3px 6px;
      border-radius: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 14px;
      color: #60a5fa;
    }
    
    .summary pre {
      background: #0f1117;
      border: 1px solid #374151;
      padding: 16px;
      border-radius: 12px;
      overflow-x: auto;
      margin: 0 0 16px 0;
    }
    .summary pre code {
      background: transparent;
      padding: 0;
      color: #e5e7eb;
      font-size: 13px;
    }

    /* ------------------------- */
    /* Bottom Metadata & Scores  */
    /* ------------------------- */
    .authors {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--card-border);
      color: var(--text-secondary);
      font-size: 14px;
    }

    .read-more-btn {
      display: inline-flex;
      align-items: center;
      margin-top: 16px;
      padding: 10px 20px;
      background: var(--text-primary);
      color: #000;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: transform 0.2s ease, background 0.2s ease;
    }
    
    .read-more-btn:hover {
      background: #fff;
      transform: translateY(-2px);
    }

    .scores-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 16px;
      margin-top: 28px;
      background: var(--accent-bg);
      padding: 24px;
      border-radius: 12px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .score-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .score-value {
      font-size: 30px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1;
      margin-bottom: 8px;
    }

    .score-item:first-child .score-value {
      color: var(--accent-hover);
    }
    
    .score-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--accent-hover);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .feedback-box {
      margin-top: 32px;
    }

    .feedback-box h3 {
      margin: 0 0 8px 0;
      font-size: 20px;
      text-align: center;
    }

    .feedback-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    .submit-btn {
      background: var(--accent-color);
      color: #fff;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s ease;
      width: 100%;
      max-width: 200px;
      margin: 0 auto;
    }

    .submit-btn:hover:not(:disabled) {
      background: var(--accent-hover);
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .footer {
      margin-top: 32px;
      padding-bottom: 40px;
      font-size: 13px;
      text-align: center;
      border-top: 1px solid var(--card-border);
      padding-top: 24px;
    }
  </style>
</head>
<body>
  
  <div class="top-bar">
    Developed by <a href="https://www.linkedin.com/in/felipe-bochini/" target="_blank" rel="noopener noreferrer">Felipe Bochini</a>
  </div>

  <header class="container header">
    <h1>Paper Rank</h1>
    <p class="muted">The best AI papers from arXiv, selected and ranked by Artificial Intelligence.</p>
  </header>

  <main class="container">
    <section class="controls card">
      <div class="control">
        <label for="weekSelect">Timeline</label>
        <select id="weekSelect" disabled></select>
      </div>

      <div class="control">
        <label for="topicSelect">Research Topic</label>
        <select id="topicSelect" disabled></select>
      </div>
    </section>

    <section id="paper" class="card paper">
      <div class="loader-container">
        <div class="spinner"></div>
        <div>Initializing Paper Rank...</div>
      </div>
    </section>

    <section class="feedback-box card">
      <h3>Share Your Feedback</h3>
      <p class="muted" style="font-size: 14px; margin-top: 0; text-align: center;">Help us improve Paper Rank. Insert your email (optional) if you'd like a reply.</p>
      
      <div class="feedback-form">
        <input type="email" id="feedbackEmail" placeholder="Email (optional)" aria-label="Email Address">
        <textarea id="feedbackMessage" rows="3" placeholder="Tell us what you think..." aria-label="Feedback Message"></textarea>
        <button id="submitBtn" onclick="sendFeedback()" class="submit-btn">Send Feedback</button>
        <p id="formStatus" style="font-size: 12px; margin-top: 4px; display: none; text-align: center;"></p>
      </div>
    </section>

    <footer class="footer muted">
      <div id="footerMeta"></div>
    </footer>
  </main>

  <script>
    const els = {
      topic: document.getElementById("topicSelect"),
      week: document.getElementById("weekSelect"),
      paper: document.getElementById("paper"),
      footerMeta: document.getElementById("footerMeta"),
    };

    let weeksList = [];
    let currentWeekData = null;

    // Configure marked to handle line breaks like Github
    marked.setOptions({
      breaks: true,
      gfm: true
    });

    async function sendFeedback() {
      const email = document.getElementById("feedbackEmail").value;
      const msg = document.getElementById("feedbackMessage").value;
      const btn = document.getElementById("submitBtn");
      const status = document.getElementById("formStatus");

      if (!msg.trim()) {
        alert("Please enter a message before sending.");
        return;
      }

      const FORMSPREE_ID = 'mkovedzd';

      btn.disabled = true;
      btn.innerText = "Sending...";
      status.style.display = "block";
      status.innerText = "Processing your feedback...";

      try {
        const response = await fetch(`https://formspree.io/f/${FORMSPREE_ID}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            email: email, 
            message: msg, 
            topic: els.topic.value, 
            week: els.week.value 
          })
        });

        if (response.ok) {
          status.innerText = "‚úì Thank you! Your feedback has been sent.";
          status.style.color = "#10b981";
          document.getElementById("feedbackMessage").value = "";
          document.getElementById("feedbackEmail").value = "";
          btn.innerText = "Sent!";
        } else {
          throw new Error();
        }
      } catch (err) {
        status.innerText = "‚úó Failed to send. Please email bochinifelipe@gmail.com directly.";
        status.style.color = "#ef4444";
        btn.disabled = false;
        btn.innerText = "Try Again";
      }
    }

    function showLoader(message = "Loading...") {
      els.paper.innerHTML = `<div class="loader-container"><div class="spinner"></div><div>${message}</div></div>`;
    }

    function showError(message) {
      els.paper.innerHTML = `<div class="loader-container" style="color: #ef4444;"><div style="font-weight: 600;">Unable to display ranking</div><div style="font-size: 14px; margin-top: 4px; color: var(--text-secondary); text-align: center;">${message}</div></div>`;
    }

    function renderWelcome() {
      els.paper.innerHTML = `
        <div class="welcome-container">
          <div class="welcome-icon">‚ú®</div>
          <h2 class="welcome-title">Explore AI Research</h2>
          <p class="welcome-text">Select a timeline and a research topic above to dive into the most innovative and impactful papers of the week, curated and scored by our AI.</p>
        </div>
      `;
    }

    async function fetchJson(path) {
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function setOptions(selectEl, items, { placeholder }) {
      selectEl.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = ""; ph.textContent = placeholder || "Select..."; ph.disabled = true;
      selectEl.appendChild(ph);
      for (const it of items) {
        const opt = document.createElement("option");
        opt.value = it.value; opt.textContent = it.label;
        selectEl.appendChild(opt);
      }
    }

    function escapeHtml(s) {
      return String(s || "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }

    function renderPaper() {
      if (!currentWeekData) return;
      
      const topicKey = els.topic.value;
      if (!topicKey) {
        renderWelcome();
        return;
      }

      const topics = currentWeekData.topics || {};
      const topic = topics[topicKey];

      if (!topic || !topic.paper) {
        els.paper.innerHTML = `<div class="loader-container"><div style="font-size: 40px; margin-bottom: 16px;">üì≠</div><div style="font-weight: 500;">No paper found</div></div>`;
        return;
      }

      const p = topic.paper;
      const topicName = topic.topic_name || topicKey;
      const authors = Array.isArray(p.authors) ? p.authors : [];
      
      // Marked.js automatically converts Markdown (**, -, >, #, `, etc.) into HTML
      const summaryHtml = p.summary ? marked.parse(p.summary) : "<span class='muted'>(Empty summary)</span>";
      const scores = p.scores || {};

      els.paper.innerHTML = `
        <div class="paper-meta">
          <span class="badge">üìö ${escapeHtml(topicName)}</span>
          ${p.published ? `<span class="badge">üìù Published: ${escapeHtml(p.published)}</span>` : ""}
        </div>
        <h2 class="paper-title"><a href="${escapeHtml(p.arxiv_url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(p.title)}</a></h2>
        
        <div id="paperSummary" class="summary">${summaryHtml}</div>
        
        ${scores.weighted ? `
        <div class="scores-grid">
          <div class="score-item"><span class="score-value">${scores.weighted.toFixed(1)}</span><span class="score-label">Global Rank</span></div>
          <div class="score-item"><span class="score-value">${scores.innovation ? scores.innovation.toFixed(1) : '-'}</span><span class="score-label">Innovation</span></div>
          <div class="score-item"><span class="score-value">${scores.impact ? scores.impact.toFixed(1) : '-'}</span><span class="score-label">Impact</span></div>
          <div class="score-item"><span class="score-value">${scores.methodology ? scores.methodology.toFixed(1) : '-'}</span><span class="score-label">Methodology</span></div>
          <div class="score-item"><span class="score-value">${scores.topic_fit ? scores.topic_fit.toFixed(1) : '-'}</span><span class="score-label">Topic Fit</span></div>
        </div>` : ''}
        
        <div class="authors"><strong>Authors:</strong> ${escapeHtml(authors.join(", ") || "Unknown")}
          <div style="margin-top:20px;"><a href="${escapeHtml(p.arxiv_url)}" class="read-more-btn" target="_blank" rel="noopener noreferrer">Read Full Paper on arXiv</a></div>
        </div>
      `;

      // Render LaTeX equations mathematically
      const summaryEl = document.getElementById("paperSummary");
      renderMathInElement(summaryEl, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ],
        throwOnError : false
      });

      const meta = [];
      if (currentWeekData.generated_at) meta.push(`Generated on: ${new Date(currentWeekData.generated_at).toLocaleDateString()}`);
      if (currentWeekData.model) meta.push(`AI Model: ${currentWeekData.model}`);
      els.footerMeta.textContent = meta.join(" ‚Ä¢ ");
    }

    async function loadWeekData(weekDate, targetTopic) {
      try {
        showLoader(`Fetching ranking for ${weekDate}...`);
        els.topic.disabled = true;
        currentWeekData = await fetchJson(`weeks/${weekDate}.json`);
        const topicsObj = currentWeekData.topics || {};
        const topicItems = Object.keys(topicsObj).map(k => ({ value: k, label: topicsObj[k]?.topic_name || k }));
        
        setOptions(els.topic, topicItems, { placeholder: "Select research topic..." });
        els.topic.disabled = false;
        
        if (targetTopic && topicItems.some(t => t.value === targetTopic)) {
          els.topic.value = targetTopic;
          renderPaper();
        } else {
          els.topic.value = "";
          renderWelcome();
        }

        const u = new URL(window.location.href);
        u.searchParams.set("week", weekDate);
        if (els.topic.value) {
           u.searchParams.set("topic", els.topic.value);
        } else {
           u.searchParams.delete("topic");
        }
        history.replaceState(null, "", u.toString());

      } catch (e) { showError("The research digest is temporarily unavailable."); }
    }

    async function main() {
      try {
        showLoader("Synchronizing...");
        weeksList = await fetchJson("weeks.json"); 
        if (!Array.isArray(weeksList) || weeksList.length === 0) { showError("No research data found."); return; }
        
        setOptions(els.week, weeksList.map(w => ({ value: w, label: w })), { placeholder: "Select week..." });
        els.week.disabled = false;
        
        const u = new URL(window.location.href);
        const targetWeek = (u.searchParams.get("week") && weeksList.includes(u.searchParams.get("week"))) ? u.searchParams.get("week") : weeksList[0];
        els.week.value = targetWeek;
        
        await loadWeekData(targetWeek, u.searchParams.get("topic"));
        
        els.week.addEventListener("change", () => loadWeekData(els.week.value, els.topic.value));
        
        els.topic.addEventListener("change", () => {
          const newUrl = new URL(window.location.href);
          newUrl.searchParams.set("week", els.week.value);
          newUrl.searchParams.set("topic", els.topic.value);
          history.replaceState(null, "", newUrl.toString());
          renderPaper();
        });
      } catch (e) { showError("Failed to connect to the Paper Rank service."); }
    }
    
    main();
  </script>
</body>
</html>